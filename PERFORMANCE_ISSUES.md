# パフォーマンス問題の調査結果

## 現状の問題

初回インデックスが非常に遅い（140ファイルで8分55秒）

## 実施した改善

### 1. エディタ統合フォーマット機能
- Vim quickfix、LSP Location、JSON等の出力形式を追加
- `--format` オプションで切り替え可能

### 2. 型ベース検索機能
- `--returns`、`--takes`、`--implements`、`--has-field` オプションを追加
- セマンティックな検索が可能に

### 3. プログレスバー実装
- `indicatif`を使用した詳細な進捗表示
- ファイルごとの処理時間を可視化
- 遅いファイルに警告表示

### 4. LSP最適化の試み
- LSPクライアントの事前起動（warm-up）機能を実装
- タイムアウトを短縮（init: 60秒→2秒、request: 10秒→1秒）
- リトライ回数を削減（3回→1回）
- バックオフ時間を短縮（100ms→50ms）

### 5. フォールバックオンリーモード
- `--fallback-only` オプションでLSPを使わないモードを追加
- 環境変数 `LSIF_FALLBACK_ONLY` でも設定可能

## パフォーマンステスト結果

| ファイル数 | LSPモード | フォールバックモード |
|-----------|-----------|-------------------|
| 20ファイル | 1.8秒 | 1.1秒 |
| 100ファイル | タイムアウト | 約70秒 |
| 140ファイル（実プロジェクト） | タイムアウト | タイムアウト |

## 判明した問題点

### 1. LSP最適化の効果は限定的
- warm-upは0.7秒で完了するが、全体の処理時間は改善せず
- タイムアウト短縮も効果なし

### 2. 根本的なボトルネックは別の場所
- フォールバックモードでも100ファイルで70秒は異常に遅い
- 100行のコードで70秒かかるのは明らかに問題

### 3. 考えられる原因
- **フォールバックインデクサー自体の実装に問題**
  - パーサーが非効率
  - シンボル抽出ロジックが重い
- **I/Oボトルネック**
  - ファイル読み込みが遅い
  - データベース書き込みが遅い
- **メモリリーク**
  - 処理が進むにつれて遅くなる可能性

## 今後の対策案

1. **プロファイリング**
   - `flamegraph`や`perf`で詳細な分析が必要
   - どの関数が時間を消費しているか特定

2. **並列処理の有効化**
   - 現在は実質的にシーケンシャル処理
   - Rayonを使った並列化の検討

3. **フォールバックインデクサーの見直し**
   - tree-sitterなど高速なパーサーへの置き換え
   - 正規表現ベースの簡易実装への切り替え

4. **データベース最適化**
   - バッチ書き込みの実装
   - トランザクションの最適化

## 結論

LSP周りの最適化を行ったが、根本的な問題は解決していない。
問題はLSPの初期化ではなく、実際のシンボル抽出処理にある可能性が高い。
詳細なプロファイリングが必要。