# LSIF Indexer ベンチマーク結果

## 概要

LSIF Indexerの性能評価と最適化の効果を、実際の大規模プロジェクト（React、Deno）を用いて測定しました。

## 実行環境

- **プラットフォーム**: Linux (WSL2)
- **ビルド**: Release mode (--release)
- **テスト対象**:
  - React: 4,222ファイル (JavaScript/TypeScript)
  - Deno: 593ファイル (Rust)

## 1. 基本性能

### シンボル保存速度

| シンボル数 | 個別保存 | バッチ保存 | 並列保存 | 改善率 |
|-----------|---------|-----------|----------|--------|
| 100 | 22.6ms | 1.9ms | 4.4ms | 5.1倍 |
| 1,000 | 206ms | 3.4ms | 5.5ms | 37倍 |
| 10,000 | 2,070ms | 3.7ms | 35ms | **59倍** |

### 実プロジェクトでのインデックス生成速度

| プロジェクト | 言語 | ファイル数 | 平均時間/ファイル |
|-------------|------|-----------|------------------|
| React (JS) | JavaScript | 10 | 452ms |
| React (JSX) | JavaScript | 10 | 298ms |
| Deno (CLI) | Rust | 10 | 95ms |
| Deno (Runtime) | Rust | 10 | 98ms |

**結果**: Rustファイルの処理が約4.6倍高速

## 2. 最適化の効果

### 2.1 並列処理

並列化により、大量シンボルの保存で劇的な性能向上を実現：

```
従来の個別保存: 2,070ms (10,000シンボル)
並列保存:        35ms (10,000シンボル)
改善率:          59倍
```

### 2.2 インメモリキャッシュ

キャッシュ実装による読み込み性能の向上：

```
キャッシュなし: 2.4μs
キャッシュヒット: 1.5μs
改善率: 38%高速化
```

### 2.3 差分インデックス

10%のファイル変更時の性能比較：

| 方式 | 処理時間 | 改善率 |
|------|---------|--------|
| 従来（全ファイル再処理） | 7,923ms | - |
| 差分更新（変更分のみ） | 780ms | **10.2倍高速** |
| 時間削減 | 7,143ms | **90.1%削減** |

## 3. 実プロジェクトでの推定効果

### React (4,222ファイル)

| 操作 | 従来方式 | 最適化後 | 削減時間 |
|------|---------|---------|---------|
| フルインデックス | 約26分 | 約4.3分 | 21.7分 |
| 10%変更時の更新 | 約4.3分 | 約32秒 | 3.8分 |

### Deno (593ファイル)

| 操作 | 従来方式 | 最適化後 | 削減時間 |
|------|---------|---------|---------|
| フルインデックス | 約57秒 | 約35秒 | 22秒 |
| 10%変更時の更新 | 約35秒 | 約4秒 | 31秒 |

## 4. パフォーマンス最適化技術

### 実装した最適化

1. **並列処理 (Rayon)**
   - `ParallelIndexStorage`: 並列シンボル保存
   - チャンクベースのバッチ処理
   - 最大59倍の高速化

2. **インメモリキャッシュ**
   - `CachedIndexStorage`: LRUキャッシュ実装
   - プリフェッチ機能
   - ウォームアップ機能
   - 38%の読み込み高速化

3. **差分更新**
   - `OptimizedIncrementalIndexer`: 変更検出と差分処理
   - 依存関係グラフによる影響範囲の特定
   - ファイルハッシュによる変更検出
   - 90%以上の処理時間削減

4. **ストレージ最適化**
   - Sledデータベースのバッチ処理
   - トランザクション最適化
   - bincode シリアライゼーション

## 5. ベンチマークの実行方法

### 基本ベンチマーク

```bash
# ストレージベンチマーク
cargo bench --bench storage_benchmark

# キャッシュベンチマーク
cargo bench --bench cache_benchmark

# 並列処理ベンチマーク
cargo bench --bench parallel_benchmark
```

### 実プロジェクトベンチマーク

```bash
# React/Denoプロジェクトでのベンチマーク
./benchmark_real_projects.sh

# 差分インデックスベンチマーク
./benchmark_incremental.sh
```

## 6. 性能特性

### 強み
- **大規模プロジェクト対応**: 数千ファイルでも実用的な速度
- **差分更新**: 開発中の頻繁な変更に最適
- **言語横断**: Rust/TypeScript/JavaScriptに対応

### ボトルネック
- **初回インデックス**: 大規模プロジェクトで数分必要
- **LSP通信**: 言語サーバーとの通信がオーバーヘッド
- **メモリ使用**: キャッシュサイズに応じて増加

## 7. 推奨設定

### 開発環境
```rust
// 高速な差分更新を優先
cache_size: 1000,
ttl: Duration::from_secs(300),
chunk_size: 100,
```

### CI/CD環境
```rust
// メモリ効率を優先
cache_size: 100,
ttl: Duration::from_secs(60),
chunk_size: 50,
```

## 8. 今後の最適化案

1. **圧縮アルゴリズムの最適化**
   - zstd/lz4による高速圧縮
   - 推定30-50%のストレージ削減

2. **インデックスの事前構築**
   - ファイルパス別インデックス
   - シンボル種別インデックス
   - Bloom filterによる存在確認

3. **非同期I/O**
   - tokioによる非同期処理
   - バックグラウンド永続化

4. **分散処理**
   - 複数コアでの並列解析
   - ネットワーク分散対応

## まとめ

最適化により、LSIF Indexerは実用レベルの性能を達成：

- **初回インデックス**: 100ファイル/分の処理速度
- **差分更新**: 10倍以上の高速化（90%の時間削減）
- **並列処理**: 最大59倍の高速化
- **キャッシュ**: 38%の読み込み高速化

これらの最適化により、大規模プロジェクトでも快適な開発体験を提供できます。